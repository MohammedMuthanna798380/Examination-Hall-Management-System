// frontend/app/src/Components/debug/TestAPI.jsx

import React, { useState } from "react";

const TestAPI = () => {
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [authToken, setAuthToken] = useState(
    localStorage.getItem("token") || ""
  );

  const addResult = (test, result) => {
    setResults((prev) => [
      ...prev,
      { test, result, timestamp: new Date().toLocaleTimeString() },
    ]);
  };

  const runTest = async (testName, url, options = {}) => {
    console.log(`๐งช ุชุดุบูู ุงุฎุชุจุงุฑ: ${testName}`);
    console.log(`๐ URL: ${url}`);
    console.log(`โ๏ธ Options:`, options);

    try {
      const headers = {
        "Content-Type": "application/json",
        Accept: "application/json",
      };

      // ุฅุถุงูุฉ token ุฅุฐุง ูุงู ูุชููุฑุงู
      if (authToken && options.includeAuth) {
        headers["Authorization"] = `Bearer ${authToken}`;
      }

      const response = await fetch(url, {
        headers,
        ...options,
      });

      console.log(`๐ ุญุงูุฉ ุงูุงุณุชุฌุงุจุฉ: ${response.status}`);
      console.log(
        `๐ Headers:`,
        Object.fromEntries(response.headers.entries())
      );

      const data = await response.json();
      console.log(`๐ฅ ุงูุจูุงูุงุช:`, data);

      addResult(testName, {
        success: response.ok,
        status: response.status,
        data: data,
        headers: Object.fromEntries(response.headers.entries()),
      });
    } catch (error) {
      console.error(`โ ุฎุทุฃ ูู ${testName}:`, error);
      addResult(testName, {
        success: false,
        error: error.message,
        stack: error.stack,
      });
    }
  };

  const runBasicTests = async () => {
    setLoading(true);
    setResults([]);

    const API_BASE = "http://localhost:8000/api";

    // ุงุฎุชุจุงุฑ 1: ูุนูููุงุช ุงูุชุดุฎูุต ุงูุฃุณุงุณูุฉ
    await runTest("1. ูุนูููุงุช ุงูุชุดุฎูุต ุงูุฃุณุงุณูุฉ", `${API_BASE}/debug-info`);

    // ุงุฎุชุจุงุฑ 2: POST ุจุณูุท
    await runTest("2. POST ุจุณูุท", `${API_BASE}/test-simple-post`, {
      method: "POST",
      body: JSON.stringify({ test: "simple post test" }),
    });

    // ุงุฎุชุจุงุฑ 3: ุฅูุดุงุก ูุณุชุฎุฏู ุจู Query Builder
    await runTest(
      "3. ุฅูุดุงุก ูุณุชุฎุฏู ุจู Query Builder",
      `${API_BASE}/test-user-creation`,
      {
        method: "POST",
        body: JSON.stringify({
          name: "ุงุฎุชุจุงุฑ ูู React",
          specialization: "ุงุฎุชุจุงุฑ",
          phone: "111111111",
          whatsapp: "111111111",
          type: "observer",
          rank: "external_employee",
        }),
      }
    );

    // ุงุฎุชุจุงุฑ 4: ุฅูุดุงุก ูุณุชุฎุฏู ุจู Eloquent
    await runTest(
      "4. ุฅูุดุงุก ูุณุชุฎุฏู ุจู Eloquent",
      `${API_BASE}/test-eloquent-user`,
      {
        method: "POST",
        body: JSON.stringify({
          name: "ุงุฎุชุจุงุฑ Eloquent ูู React",
          specialization: "ุงุฎุชุจุงุฑ",
          phone: "222222222",
          whatsapp: "222222222",
          type: "supervisor",
          rank: "college_employee",
        }),
      }
    );

    // ุงุฎุชุจุงุฑ 5: ุงููุณุงุฑ ุบูุฑ ุงููุญูู ูููุณุชุฎุฏููู
    await runTest(
      "5. ุงููุณุงุฑ ุบูุฑ ุงููุญูู ูููุณุชุฎุฏููู",
      `${API_BASE}/test-users-unprotected`,
      {
        method: "POST",
        body: JSON.stringify({
          name: "ุงุฎุชุจุงุฑ ุงููุณุงุฑ ุบูุฑ ุงููุญูู",
          specialization: "ุงุฎุชุจุงุฑ",
          phone: "333333333",
          whatsapp: "333333333",
          type: "observer",
          rank: "external_employee",
        }),
      }
    );

    setLoading(false);
  };

  const runAuthTests = async () => {
    setLoading(true);
    setResults([]);

    const API_BASE = "http://localhost:8000/api";

    // ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฏุฎูู
    await runTest("6. ุชุณุฌูู ุงูุฏุฎูู", `${API_BASE}/login`, {
      method: "POST",
      body: JSON.stringify({
        username: "admin",
        password: "admin123",
      }),
    });

    // ุงุฎุชุจุงุฑ ุงููุณุงุฑ ุงููุญูู ุจุฏูู token
    await runTest("7. ุงููุณุงุฑ ุงููุญูู ุจุฏูู token", `${API_BASE}/users`, {
      method: "POST",
      body: JSON.stringify({
        name: "ุงุฎุชุจุงุฑ ุจุฏูู token",
        specialization: "ุงุฎุชุจุงุฑ",
        phone: "444444444",
        whatsapp: "444444444",
        type: "observer",
        rank: "external_employee",
      }),
    });

    // ุงุฎุชุจุงุฑ ุงููุณุงุฑ ุงููุญูู ูุน token
    if (authToken) {
      await runTest("8. ุงููุณุงุฑ ุงููุญูู ูุน token", `${API_BASE}/users`, {
        method: "POST",
        includeAuth: true,
        body: JSON.stringify({
          name: "ุงุฎุชุจุงุฑ ูุน token",
          specialization: "ุงุฎุชุจุงุฑ",
          phone: "555555555",
          whatsapp: "555555555",
          type: "observer",
          rank: "external_employee",
        }),
      });
    }

    setLoading(false);
  };

  const loginWithTestCredentials = async () => {
    try {
      const response = await fetch("http://localhost:8000/api/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify({
          username: "admin",
          password: "admin123",
        }),
      });

      const data = await response.json();

      if (response.ok && data.status && data.access_token) {
        setAuthToken(data.access_token);
        localStorage.setItem("token", data.access_token);
        alert("โ ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ!");
      } else {
        alert("โ ูุดู ุชุณุฌูู ุงูุฏุฎูู: " + (data.message || "ุฎุทุฃ ุบูุฑ ูุญุฏุฏ"));
      }
    } catch (error) {
      alert("โ ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: " + error.message);
    }
  };

  return (
    <div
      style={{
        padding: "20px",
        fontFamily: "Arial, sans-serif",
        backgroundColor: "#f5f5f5",
        minHeight: "100vh",
      }}
    >
      <div
        style={{
          backgroundColor: "white",
          padding: "20px",
          borderRadius: "10px",
          boxShadow: "0 2px 4px rgba(0,0,0,0.1)",
          marginBottom: "20px",
        }}
      >
        <h1
          style={{
            color: "#2c3e50",
            textAlign: "center",
            marginBottom: "20px",
          }}
        >
          ๐งช ุงุฎุชุจุงุฑ API - ุชุดุฎูุต ุงููุดุงูู
        </h1>

        {/* ุญุงูุฉ ุงููุตุงุฏูุฉ */}
        <div
          style={{
            padding: "15px",
            backgroundColor: authToken ? "#d5f4e6" : "#fdeaea",
            borderRadius: "8px",
            border: `2px solid ${authToken ? "#27ae60" : "#e74c3c"}`,
            marginBottom: "20px",
            textAlign: "center",
          }}
        >
          <h3 style={{ margin: "0 0 10px 0" }}>
            {authToken ? "โ ููุตุงุฏู ุนููู" : "โ ุบูุฑ ููุตุงุฏู"}
          </h3>
          {authToken ? (
            <p style={{ margin: 0, fontSize: "12px", wordBreak: "break-all" }}>
              Token: {authToken.substring(0, 50)}...
            </p>
          ) : (
            <button
              onClick={loginWithTestCredentials}
              style={{
                padding: "10px 20px",
                backgroundColor: "#e67e22",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
              }}
            >
              ุชุณุฌูู ุฏุฎูู ุชุฌุฑูุจู
            </button>
          )}
        </div>

        <div
          style={{
            textAlign: "center",
            marginBottom: "20px",
            display: "flex",
            gap: "10px",
            justifyContent: "center",
          }}
        >
          <button
            onClick={runBasicTests}
            disabled={loading}
            style={{
              padding: "15px 30px",
              fontSize: "16px",
              fontWeight: "bold",
              backgroundColor: loading ? "#95a5a6" : "#3498db",
              color: "white",
              border: "none",
              borderRadius: "8px",
              cursor: loading ? "not-allowed" : "pointer",
              boxShadow: "0 2px 4px rgba(0,0,0,0.2)",
              transition: "all 0.3s ease",
            }}
          >
            {loading ? "๐ ุฌุงุฑู..." : "๐ ุงุฎุชุจุงุฑุงุช ุฃุณุงุณูุฉ"}
          </button>

          <button
            onClick={runAuthTests}
            disabled={loading}
            style={{
              padding: "15px 30px",
              fontSize: "16px",
              fontWeight: "bold",
              backgroundColor: loading ? "#95a5a6" : "#9b59b6",
              color: "white",
              border: "none",
              borderRadius: "8px",
              cursor: loading ? "not-allowed" : "pointer",
              boxShadow: "0 2px 4px rgba(0,0,0,0.2)",
              transition: "all 0.3s ease",
            }}
          >
            {loading ? "๐ ุฌุงุฑู..." : "๐ ุงุฎุชุจุงุฑุงุช ุงููุตุงุฏูุฉ"}
          </button>
        </div>

        <div
          style={{
            padding: "15px",
            backgroundColor: "#e8f4fd",
            borderRadius: "8px",
            border: "1px solid #3498db",
            marginBottom: "20px",
          }}
        >
          <h3 style={{ margin: "0 0 10px 0", color: "#2980b9" }}>
            ๐ ุชุนูููุงุช:
          </h3>
          <ol style={{ margin: 0, paddingLeft: "20px" }}>
            <li>ุงุจุฏุฃ ุจู "ุงุฎุชุจุงุฑุงุช ุฃุณุงุณูุฉ" ูุชุดุฎูุต ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูCORS</li>
            <li>ุงุณุชุฎุฏู "ุงุฎุชุจุงุฑุงุช ุงููุตุงุฏูุฉ" ูุงุฎุชุจุงุฑ ุงููุณุงุฑุงุช ุงููุญููุฉ</li>
            <li>ุงูุชุญ Developer Tools (F12) โ Console</li>
            <li>
              ูู Laravel terminal: <code>tail -f storage/logs/laravel.log</code>
            </li>
          </ol>
        </div>
      </div>

      {results.length > 0 && (
        <div
          style={{
            backgroundColor: "white",
            padding: "20px",
            borderRadius: "10px",
            boxShadow: "0 2px 4px rgba(0,0,0,0.1)",
          }}
        >
          <h2 style={{ color: "#2c3e50", marginBottom: "20px" }}>
            ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑุงุช:
          </h2>

          <div style={{ maxHeight: "600px", overflowY: "auto" }}>
            {results.map((result, index) => (
              <div
                key={index}
                style={{
                  margin: "15px 0",
                  padding: "20px",
                  border: "2px solid",
                  borderColor: result.result.success ? "#27ae60" : "#e74c3c",
                  borderRadius: "8px",
                  backgroundColor: result.result.success
                    ? "#d5f4e6"
                    : "#fdeaea",
                }}
              >
                <h4
                  style={{
                    margin: "0 0 10px 0",
                    color: result.result.success ? "#27ae60" : "#e74c3c",
                  }}
                >
                  {result.test} - {result.timestamp}
                </h4>

                {result.result.success ? (
                  <div>
                    <p
                      style={{
                        margin: "5px 0",
                        fontSize: "16px",
                        fontWeight: "bold",
                      }}
                    >
                      โ <span style={{ color: "#27ae60" }}>ูุฌุญ</span> - ุงูุญุงูุฉ:{" "}
                      {result.result.status}
                    </p>
                    <details style={{ marginTop: "10px" }}>
                      <summary
                        style={{ cursor: "pointer", fontWeight: "bold" }}
                      >
                        ุนุฑุถ ุงูุจูุงูุงุช ุงูููุณุชููุฉ
                      </summary>
                      <pre
                        style={{
                          fontSize: "12px",
                          overflow: "auto",
                          backgroundColor: "#f8f9fa",
                          padding: "10px",
                          borderRadius: "4px",
                          marginTop: "10px",
                          border: "1px solid #dee2e6",
                        }}
                      >
                        {JSON.stringify(result.result.data, null, 2)}
                      </pre>
                    </details>
                  </div>
                ) : (
                  <div>
                    <p
                      style={{
                        margin: "5px 0",
                        fontSize: "16px",
                        fontWeight: "bold",
                      }}
                    >
                      โ <span style={{ color: "#e74c3c" }}>ูุดู</span>
                    </p>
                    <p>
                      <strong>ุงูุฎุทุฃ:</strong> {result.result.error}
                    </p>
                    {result.result.status && (
                      <p>
                        <strong>ุงูุญุงูุฉ:</strong> {result.result.status}
                      </p>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

export default TestAPI;
